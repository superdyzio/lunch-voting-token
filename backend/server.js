require("dotenv").config();

const express = require("express");
const http = require("http");
const fs = require("fs");

const webServer = http.createServer((req, res) => {
	if (req.url.includes("main.js")) {
		res.writeHead(200, { "content-type": "text/javascript" });
		fs.createReadStream("frontend/main.js").pipe(res);
	} else if (req.url.includes("styles.css")) {
		res.writeHead(200, { "content-type": "text/css" });
		fs.createReadStream("frontend/styles.css").pipe(res);
	} else if (req.url.includes("assets/")) {
		const assetName = req.url.split("/").pop();
		res.writeHead(200, { "content-type": "image/png" });
		fs.createReadStream(`frontend/assets/${assetName}`).pipe(res);
	} else {
		res.writeHead(200, { "content-type": "text/html" });
		fs.createReadStream("frontend/index.html").pipe(res);
	}
});

webServer.listen(3030);

const cors = require("cors");
const Web3 = require("web3");
const web3 = new Web3(process.env.API_URL);
const app = express();

app.use(express.json());
app.use(cors());

const contractABI = [
	{
		inputs: [
			{
				internalType: "string",
				name: "name",
				type: "string",
			},
			{
				internalType: "string",
				name: "symbol",
				type: "string",
			},
		],
		stateMutability: "nonpayable",
		type: "constructor",
	},
	{
		anonymous: false,
		inputs: [
			{
				indexed: true,
				internalType: "address",
				name: "owner",
				type: "address",
			},
			{
				indexed: true,
				internalType: "address",
				name: "spender",
				type: "address",
			},
			{
				indexed: false,
				internalType: "uint256",
				name: "value",
				type: "uint256",
			},
		],
		name: "Approval",
		type: "event",
	},
	{
		anonymous: false,
		inputs: [
			{
				indexed: true,
				internalType: "address",
				name: "from",
				type: "address",
			},
			{
				indexed: true,
				internalType: "address",
				name: "to",
				type: "address",
			},
			{
				indexed: false,
				internalType: "uint256",
				name: "value",
				type: "uint256",
			},
		],
		name: "Transfer",
		type: "event",
	},
	{
		inputs: [
			{
				internalType: "string",
				name: "name_",
				type: "string",
			},
		],
		name: "addOption",
		outputs: [],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "owner",
				type: "address",
			},
			{
				internalType: "address",
				name: "spender",
				type: "address",
			},
		],
		name: "allowance",
		outputs: [
			{
				internalType: "uint256",
				name: "",
				type: "uint256",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "spender",
				type: "address",
			},
			{
				internalType: "uint256",
				name: "amount",
				type: "uint256",
			},
		],
		name: "approve",
		outputs: [
			{
				internalType: "bool",
				name: "",
				type: "bool",
			},
		],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "account",
				type: "address",
			},
		],
		name: "balanceOf",
		outputs: [
			{
				internalType: "uint256",
				name: "",
				type: "uint256",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [],
		name: "decimals",
		outputs: [
			{
				internalType: "uint8",
				name: "",
				type: "uint8",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "spender",
				type: "address",
			},
			{
				internalType: "uint256",
				name: "subtractedValue",
				type: "uint256",
			},
		],
		name: "decreaseAllowance",
		outputs: [
			{
				internalType: "bool",
				name: "",
				type: "bool",
			},
		],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address payable",
				name: "adr",
				type: "address",
			},
		],
		name: "destroyContract",
		outputs: [],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [],
		name: "endVoting",
		outputs: [],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [],
		name: "getAllParticipantNames",
		outputs: [
			{
				internalType: "string[]",
				name: "",
				type: "string[]",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [],
		name: "getLastWinner",
		outputs: [
			{
				internalType: "string",
				name: "",
				type: "string",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [],
		name: "getOptions",
		outputs: [
			{
				internalType: "string[]",
				name: "",
				type: "string[]",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "addr",
				type: "address",
			},
		],
		name: "getParticipantName",
		outputs: [
			{
				internalType: "string",
				name: "",
				type: "string",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "spender",
				type: "address",
			},
			{
				internalType: "uint256",
				name: "addedValue",
				type: "uint256",
			},
		],
		name: "increaseAllowance",
		outputs: [
			{
				internalType: "bool",
				name: "",
				type: "bool",
			},
		],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "addr",
				type: "address",
			},
		],
		name: "isParticipant",
		outputs: [
			{
				internalType: "bool",
				name: "",
				type: "bool",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [],
		name: "lastWinner",
		outputs: [
			{
				internalType: "string",
				name: "",
				type: "string",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [],
		name: "name",
		outputs: [
			{
				internalType: "string",
				name: "",
				type: "string",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "uint256",
				name: "",
				type: "uint256",
			},
		],
		name: "optionNames",
		outputs: [
			{
				internalType: "string",
				name: "",
				type: "string",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "uint256",
				name: "",
				type: "uint256",
			},
			{
				internalType: "uint256",
				name: "",
				type: "uint256",
			},
		],
		name: "optionVoters",
		outputs: [
			{
				internalType: "address",
				name: "",
				type: "address",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "uint256",
				name: "",
				type: "uint256",
			},
		],
		name: "optionVotes",
		outputs: [
			{
				internalType: "uint256",
				name: "",
				type: "uint256",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "addr",
				type: "address",
			},
			{
				internalType: "string",
				name: "name",
				type: "string",
			},
		],
		name: "registerParticipant",
		outputs: [],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "addr",
				type: "address",
			},
		],
		name: "removeParticipant",
		outputs: [],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "uint256",
				name: "allocation",
				type: "uint256",
			},
		],
		name: "startVoting",
		outputs: [],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [],
		name: "symbol",
		outputs: [
			{
				internalType: "string",
				name: "",
				type: "string",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [],
		name: "totalSupply",
		outputs: [
			{
				internalType: "uint256",
				name: "",
				type: "uint256",
			},
		],
		stateMutability: "view",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "to",
				type: "address",
			},
			{
				internalType: "uint256",
				name: "amount",
				type: "uint256",
			},
		],
		name: "transfer",
		outputs: [
			{
				internalType: "bool",
				name: "",
				type: "bool",
			},
		],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "address",
				name: "from",
				type: "address",
			},
			{
				internalType: "address",
				name: "to",
				type: "address",
			},
			{
				internalType: "uint256",
				name: "amount",
				type: "uint256",
			},
		],
		name: "transferFrom",
		outputs: [
			{
				internalType: "bool",
				name: "",
				type: "bool",
			},
		],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [
			{
				internalType: "uint256",
				name: "position",
				type: "uint256",
			},
			{
				internalType: "uint256",
				name: "votes",
				type: "uint256",
			},
		],
		name: "vote",
		outputs: [],
		stateMutability: "nonpayable",
		type: "function",
	},
	{
		inputs: [],
		name: "voteOpen",
		outputs: [
			{
				internalType: "bool",
				name: "",
				type: "bool",
			},
		],
		stateMutability: "view",
		type: "function",
	},
];
const contract = new web3.eth.Contract(
	contractABI,
	process.env.CONTRACT_ADDRESS
);

web3.eth.accounts.wallet.add(process.env.WALLET_KEY);

app.get("/get-contract-data", async (req, res) => {
	res.json({ contractABI, contractAddress: process.env.CONTRACT_ADDRESS });
});

app.get("/get-deployer-address", async (req, res) => {
	const address = await contract.methods.owner().call();
	res.send(address);
});

app.get("/get-my-balance", async (req, res) => {
	const wei = await web3.eth.getBalance(process.env.WALLET_ADDRESS);
	const ethBalance = web3.utils.fromWei(wei, "ether");
	const balance = await contract.methods
		.balanceOf(process.env.WALLET_ADDRESS)
		.call();
	res.json({ ethBalance, balance });
});

app.get("/get-last-winner", async (req, res) => {
	const name = await contract.methods.getLastWinner().call();
	res.send(name);
});

app.get("/get-all-participant-names", async (req, res) => {
	const names = await contract.methods.getAllParticipantNames().call();
	res.json(names);
});

app.get("/get-options", async (req, res) => {
	const owner = await contract.methods.owner().call();
	const options = await contract.methods.getOptions().call({ from: owner });
	res.json(options);
});

app.post("/add-participant", async (req, res) => {
	const owner = await contract.methods.owner().call();
	await contract.methods
		.registerParticipant(req.body.address, req.body.name)
		.send({ from: owner, gasLimit: 2000000 });
	res.send(`Wallet ${req.body.address} registered as ${req.body.name}`);
});

app.post("/add-option", async (req, res) => {
	const owner = await contract.methods.owner().call();
	await contract.methods
		.addOption(req.body.name)
		.send({ from: owner, gasLimit: 2000000 });
	res.send(`Option ${req.body.name} added`);
});

app.post("/start-voting", async (req, res) => {
	const owner = await contract.methods.owner().call();
	await contract.methods
		.startVoting(req.body.amount)
		.send({ from: owner, gasLimit: 2000000 });
	res.send("Voting started");
});

app.post("/end-voting", async (req, res) => {
	const owner = await contract.methods.owner().call();
	await contract.methods.endVoting().send({ from: owner, gasLimit: 2000000 });
	res.send("Vote ended");
});

app.post("/vote", async (req, res) => {
	const owner = await contract.methods.owner().call();
	await contract.methods
		.vote(req.body.position, req.body.votes)
		.send({ from: owner, gasLimit: 2000000 });
	res.send(`${req.body.votes} added to ${req.body.position}`);
});

app.listen(3000, () => {
	console.log("Example app listening on port 3000");
	console.log("Frontend on port 3030");
});
